<!--
 * @LastEditors: Bot80926
 * @LastEditTime: 2023-05-10 00:28:41
 * @FilePath: /contract-notebook/function-name-to-hash-encode-and-decode/README.md
 * Copyright (c) 2023 by Bot80926, All Rights Reserved.
-->

## Solidityä¸­å“ˆå¸Œå‡½æ•°çš„ç¼–ç ä¸è§£ç 

### èµ·å› 

å†™è¿™ç¯‡æ–‡ç« çš„èµ·å› ï¼Œæ˜¯æˆ‘åœ¨å‰ç«¯è°ƒè¯•åˆçº¦çš„æ—¶å€™ï¼Œå‘ç°åˆçº¦æŠ¥é”™äº†ï¼Œç‚¹å¼€å‘½ä»¤è¡ŒæŠ¥é”™ï¼Œå‘ç°è¿”å›çš„æ˜¯åˆçº¦çš„ `callData`ï¼Œæˆ‘ç›´æ¥è¡¨æ¼”ä¸€ä¸ªçœ¼å‰ä¸€é»‘ï¼Œæˆ‘æ€ä¹ˆç›´æ¥çš„çŸ¥é“æ˜¯è°ƒç”¨å“ªä¸ªæ–¹æ³•çš„æ—¶å€™æŠ¥é”™å‘¢ï¼Ÿ äºæ˜¯æœ‰äº†è¿™ç¯‡æ–‡ç« çš„æ¢ç´¢

- ç›®æ ‡ï¼š å¦‚ä½•æ ¹æ® `callData` è§£æå‡ºè°ƒç”¨å‡½æ•°

- å†…å®¹ï¼šä»åˆçº¦å°ç™½çš„è§’åº¦ï¼Œä»å“ˆå¸Œå‡½æ•°çš„å‰ä¸–ä»Šç”Ÿå¼€å§‹è®²èµ·ã€‚å¦‚æœä½ å·²ç»å¾ˆäº†è§£è¿™éƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥ç›´æ¥åˆ’åˆ°åº•ã€‚
-ç”¨åˆ°çš„åº“ï¼š ethers \ foundry

![æŠ¥é”™æˆªå›¾](Img/img_1.png)


## å“ˆå¸Œå‡½æ•°çš„å‰ä¸–ä»Šç”Ÿ


è¿™ä¸€ä¸ªéƒ¨åˆ†ç›´æ¥å¼•ç”¨ WTF è¯¾ç¨‹é‡Œå¯¹å“ˆå¸Œå‡½æ•°çš„æè¿°ï¼Œè®²è§£çš„å¾ˆè¯¦ç»†ã€‚ æ„Ÿè°¢ç¤¾åŒºçš„åŠ›é‡ [github.com/AmazingAng/WTFSolidity](https://github.com/AmazingAng/WTF-Solidity/blob/main/28_Hash/readme.md)

-----


å“ˆå¸Œå‡½æ•°ï¼ˆhash functionï¼‰æ˜¯ä¸€ä¸ªå¯†ç å­¦æ¦‚å¿µï¼Œå®ƒå¯ä»¥å°†ä»»æ„é•¿åº¦çš„æ¶ˆæ¯è½¬æ¢ä¸ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„å€¼ï¼Œè¿™ä¸ªå€¼ä¹Ÿç§°ä½œå“ˆå¸Œï¼ˆhashï¼‰ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹å“ˆå¸Œå‡½æ•°åŠåœ¨`solidity`çš„åº”ç”¨

ä¸€ä¸ªå¥½çš„å“ˆå¸Œå‡½æ•°åº”è¯¥å…·æœ‰ä»¥ä¸‹å‡ ä¸ª**ç‰¹æ€§**ï¼š
- å•å‘æ€§ï¼šä»è¾“å…¥çš„æ¶ˆæ¯åˆ°å®ƒçš„å“ˆå¸Œçš„æ­£å‘è¿ç®—ç®€å•ä¸”å”¯ä¸€ç¡®å®šï¼Œè€Œåè¿‡æ¥éå¸¸éš¾ï¼Œåªèƒ½é æš´åŠ›æšä¸¾ã€‚ 
- çµæ•æ€§ï¼šè¾“å…¥çš„æ¶ˆæ¯æ”¹å˜ä¸€ç‚¹å¯¹å®ƒçš„å“ˆå¸Œæ”¹å˜å¾ˆå¤§ã€‚
- é«˜æ•ˆæ€§ï¼šä»è¾“å…¥çš„æ¶ˆæ¯åˆ°å“ˆå¸Œçš„è¿ç®—é«˜æ•ˆã€‚
- å‡ä¸€æ€§ï¼šæ¯ä¸ªå“ˆå¸Œå€¼è¢«å–åˆ°çš„æ¦‚ç‡åº”è¯¥åŸºæœ¬ç›¸ç­‰ã€‚
- æŠ—ç¢°æ’æ€§ï¼š
    - å¼±æŠ—ç¢°æ’æ€§ï¼šç»™å®šä¸€ä¸ªæ¶ˆæ¯`x`ï¼Œæ‰¾åˆ°å¦ä¸€ä¸ªæ¶ˆæ¯`x'`ä½¿å¾—`hash(x) = hash(x')`æ˜¯å›°éš¾çš„ã€‚
    - å¼ºæŠ—ç¢°æ’æ€§ï¼šæ‰¾åˆ°ä»»æ„`x`å’Œ`x'`ï¼Œä½¿å¾—`hash(x) = hash(x')`æ˜¯å›°éš¾çš„ã€‚

### Hashçš„åº”ç”¨
- ç”Ÿæˆæ•°æ®å”¯ä¸€æ ‡è¯†
- åŠ å¯†ç­¾å
- å®‰å…¨åŠ å¯†

### Keccak256
`Keccak256`å‡½æ•°æ˜¯`solidity`ä¸­æœ€å¸¸ç”¨çš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨æ³•éå¸¸ç®€å•ï¼š
```solidity
å“ˆå¸Œ = keccak256(æ•°æ®);
```
### Keccak256å’Œsha3
è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰è¶£çš„äº‹æƒ…ï¼š
1. sha3ç”±keccakæ ‡å‡†åŒ–è€Œæ¥ï¼Œåœ¨å¾ˆå¤šåœºåˆä¸‹Keccakå’ŒSHA3æ˜¯åŒä¹‰è¯ï¼Œä½†åœ¨2015å¹´8æœˆSHA3æœ€ç»ˆå®Œæˆæ ‡å‡†åŒ–æ—¶ï¼ŒNISTè°ƒæ•´äº†å¡«å……ç®—æ³•ã€‚**æ‰€ä»¥SHA3å°±å’Œkeccakè®¡ç®—çš„ç»“æœä¸ä¸€æ ·**ï¼Œè¿™ç‚¹åœ¨å®é™…å¼€å‘ä¸­è¦æ³¨æ„ã€‚
2. ä»¥å¤ªåŠåœ¨å¼€å‘çš„æ—¶å€™sha3è¿˜åœ¨æ ‡å‡†åŒ–ä¸­ï¼Œæ‰€ä»¥é‡‡ç”¨äº†keccakï¼Œæ‰€ä»¥Ethereumå’ŒSolidityæ™ºèƒ½åˆçº¦ä»£ç ä¸­çš„SHA3æ˜¯æŒ‡Keccak256ï¼Œè€Œä¸æ˜¯æ ‡å‡†çš„NIST-SHA3ï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œç›´æ¥åœ¨åˆçº¦ä»£ç ä¸­å†™æˆKeccak256æ˜¯æœ€æ¸…æ™°çš„ã€‚


## ç”Ÿæˆå‡½æ•°å“ˆå¸Œ

ä»‹ç»å®Œå®šä¹‰ï¼Œæˆ‘ä»¬å›å½’åˆ°æ–‡ç« ä¸»é¢˜ï¼Œç¬¬ä¸€æ­¥ï¼Œå¦‚ä½•æŠŠ ` balanceOf(address) => 0x70a08231 `

- ethersåº“é‡Œæä¾›äº†ä¸¤ç§æ–¹å¼

1. `ethers.utils.id('balanceOf(address)')` å¯ä»¥çœ‹åˆ°è¾“å…¥ä¸€ä¸ª `text`, ä¼šè¿”å›ä¸€ä¸ª `KECCAK256` çš„å“ˆå¸Œ
![](Img/img_2.png)


2. å…ˆå°† `String` è½¬æ¢æˆ `Utf8Bytes` çš„æ ¼å¼ï¼Œç„¶åå†ç”¨ `keccak256` å“ˆå¸ŒåŠ å¯†. è¿™é‡Œè¦æ³¨æ„ä¸èƒ½ç›´æ¥ `ethers.utils.keccak256(`balanceOf(address)`)` è¿™ç§æ–¹å¼ä¼šæŠ¥é”™ï¼Œ`keccak256` åªæ”¯æŒ `DataHexstring` æ ¼å¼çš„è½¬æ¢
 
   ![](Img/img_4.png)

```javascript
const textToUtf8Bytes = ethers.utils.toUtf8Bytes('balanceOf(address)')
const hashResult = ethers.utils.keccak256(textToUtf8Bytes)
```


3. è¡¥å……ä¸Šé¢ `textToUtf8Bytes` å¯ä»¥ç”¨ `ethers.utils.toUtf8String` åè§£å‡º `String`



è¾“å‡ºå¦‚ä¸‹ï¼Œé™¤å¼€ 0x çš„å‰å››ä¸ªbytes  `70a08231` ä¸ºæˆ‘ä»¬è¦çš„ç›®æ ‡å‡½æ•°çš„å“ˆå¸Œï¼š

![](Img/img_3.png)

## åè§£å“ˆå¸Œå‡½æ•°

ä¸Šé¢æˆ‘ä»¬è·å¾—äº†å‡½æ•°çš„å“ˆå¸Œï¼Œé‚£ä¹ˆç°åœ¨åˆ°ç¬¬äºŒæ­¥ï¼Œå¦‚ä½•æŠŠ ` 0x70a08231 => balanceOf(address) `

- åè§£ä¹Ÿæ˜¯ä¸¤ç§æ–¹å¼ ï¼ˆå¯èƒ½ä¸å…¨ï¼Œæˆ‘ç›®å‰åªçŸ¥é“è¿™ä¸¤ä¸ªåŠæ³•ï¼‰
- ç¬¬ä¸€ç§ï¼š [bytes4_signature](https://www.4byte.directory/signatures/?bytes4_signature=0x70a08231) å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå·¨å¤§çš„  `Text Signature` ğŸ†š 	`Bytes Signature` çš„æ•°æ®åº“ï¼Œé‡Œé¢ä¼šå®šæ—¶å»æ‰«é“¾ä¸Šçš„åˆçº¦ï¼Œå¹¶å°†ä»–ä»¬å¯¹åº”çš„ å“ˆå¸Œå€¼ ä¸ æ–¹æ³•å å­˜ä¸‹æ¥ã€‚èƒ½æ»¡è¶³æˆ‘ä»¬å¤§å¤šæ•°å¼€å‘çš„éœ€æ±‚
- ç¬¬äºŒç§ï¼Œç”¨å‘½ä»¤è¡Œè§£å¯†ã€‚ 
  - Step1: [instal foundry](https://book.getfoundry.sh/getting-started/installation)
  - Step2: `cast 4b 70a08231`
  - ![](Img/img_5.png)


## è¡¥å……çŸ¥è¯†ï¼šå‰ç«¯ä»”ä¼šåœ¨å“ªé‡Œç”¨åˆ°å“ˆå¸Œå‡½æ•°ï¼Ÿ

ç­”ï¼š **EIP-165** [è§„èŒƒæ–‡ç« ](https://learnblockchain.cn/docs/eips/eip-165.html#%E8%A7%84%E8%8C%83)

```solidity
pragma solidity ^0.4.20;

interface ERC165 {
    /// @notice æŸ¥è¯¢ä¸€ä¸ªåˆçº¦æ—¶å€™å®ç°äº†ä¸€ä¸ªæ¥å£
    /// @param interfaceID  å‚æ•°ï¼šæ¥å£ID, å‚è€ƒä¸Šé¢çš„å®šä¹‰
    /// @return true å¦‚æœå‡½æ•°å®ç°äº† interfaceID (interfaceID ä¸ä¸º 0xffffffff )è¿”å›true, å¦åˆ™ä¸º false
    function supportsInterface(bytes4 interfaceID) external view returns (bool);
}
```


åœ¨ `EIP-165` ä¸­ æè®®äº†æ ‡å‡†åŒ–æ¥å£çš„æ¦‚å¿µï¼Œå¹¶æ ‡å‡†åŒ–äº†æ¥å£æ ‡è¯†ã€‚ è¿™ä¹ˆè¯´å¯èƒ½æœ‰äº›æŠ½è±¡ã€‚ ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼ŒçŸ¥é“è¯¥åˆçº¦æ˜¯å¦æ”¯æŒæŸä¸ªæ¥å£ã€‚ æ¯”å¦‚ å¯¹äº ä¸€ä¸ª `ERC-721` æ ‡å‡†çš„ NFT æ¥è¯´ï¼Œ æˆ‘æ€ä¹ˆçŸ¥é“ä»–æ˜¯å¦å…¼å®¹æ”¯æŒ `ERC-2981` å‘¢ ?

- é¦–å…ˆæ˜ç¡® [ERC-2981](https://eips.ethereum.org/EIPS/eip-2981) å¯¹äº `ERC-721` å¤šäº†å“ªäº›èƒ½åŠ›ï¼Ÿ
  - å¯ä»¥ä¸º NFT è®¾ç½®ç‰ˆç¨ï¼Œ æ–°å¢äº† `royaltyInfo(uint256,uint256)` æŸ¥è¯¢æ–¹æ³•
  - é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™ä¸‹é¢è¿™ä¹ˆä¸€ä¸ªå‡½æ•°ï¼Œæ¥åˆ¤æ–­ NFT çš„ Fee
  - å› ä¸º function å®šä¹‰äº† `supportsInterface` éœ€è¦ä¼ å…¥ä¸€ä¸ª bytes4 ç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ å…¥ `0x2a55205a`ï¼Œ å¯¹åº” `royaltyInfo(uint256,uint256)`ã€‚ å¦‚æœè¿”å› trueï¼Œ åˆ™è¯´æ˜ è¿™ä¸ª NFT å…¼å®¹äº† ERC-2981 æ ‡å‡†ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å®ƒå¯¹åº”çš„ç‰ˆç¨è´¹ç‡ã€‚

```javascript
export const checkNftFeeAndGetFee = async ({ address, signer, tokenId }) => {
  const abi = ["function supportsInterface(bytes4) public view returns(bool)"];
  const checkContract = await createContract(address, abi, signer);
  const isSupportErc2981 = await checkContract.supportsInterface(0x2a55205a);
  let fee = 0;
  if (isSupportErc2981) {
    const nftContract = await createContract(address, erc2981ABI, signer);
    const result = await nftContract.royaltyInfo(
      tokenId,
      "100000000000000000000" // 100 * 10 ** 18, å› ä¸ºè¦ç®—è´¹ç‡ï¼Œç›´æ¥æŒ‰100å—é’±ç®—ï¼Œè¿”å›å¤šå°‘å°±æ˜¯å¯¹åº”çš„è´¹ç‡ï¼Œæ¯”å¦‚ 1 å°±æ˜¯ 1% è´¹ç‡ï¼Œ
    );
    fee = Number(result?.royaltyAmount) / 10 ** 18;
  } else {
    fee = 0;
  }
  return fee.toString();
};
```